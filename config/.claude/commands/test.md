Generate comprehensive unit tests for this code. Include:
- Test cases for normal functionality
- Edge cases and error conditions
- Mock external dependencies if needed
- Use the project's existing test framework and patterns